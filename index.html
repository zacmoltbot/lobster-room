<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:rgba(255,255,255,0.03);--surfaceHover:rgba(255,255,255,0.045);--border:rgba(255,255,255,0.06);--accent:#6366f1;--accent2:#9333ea;--green:#4ade80;--yellow:#facc15;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;--text:#e5e5e5;--textStrong:#ffffff;--muted:#737373;--dim:#525252;--darker:#404040;--tableBg:rgba(255,255,255,0.025);--tableHover:rgba(255,255,255,0.05);--scrollThumb:rgba(255,255,255,0.1)}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:20px}
.container{max-width:1440px;margin:0 auto}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.header-left{display:flex;align-items:center;gap:12px}
.avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px}
.header-title{font-size:20px;font-weight:700;color:var(--textStrong)}
.header-status{display:flex;align-items:center;gap:6px;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot-on{background:var(--green);box-shadow:0 0 8px rgba(74,222,128,0.5)}
.dot-off{background:var(--red);box-shadow:0 0 8px rgba(248,113,113,0.5)}
.dot-warn{background:var(--yellow);box-shadow:0 0 8px rgba(250,204,21,0.5)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 2s ease-in-out infinite}
.header-right{display:flex;align-items:center;gap:12px}
.countdown{font-size:11px;color:var(--dim);font-variant-numeric:tabular-nums;min-width:24px}
.refresh-btn{background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:8px;color:var(--muted);font-size:12px;cursor:pointer;transition:all .15s}
.refresh-btn:hover{background:var(--surfaceHover);color:var(--textStrong)}

/* Theme switcher */
.theme-picker{position:relative;display:inline-block}
.theme-btn{background:var(--surface);border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:14px;cursor:pointer;transition:all .15s;line-height:1}
.theme-btn:hover{background:var(--surfaceHover);color:var(--textStrong)}
.theme-menu{display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:6px;min-width:200px;z-index:100;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.theme-menu.open{display:block}
.theme-menu-label{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding:6px 10px 4px}
.theme-opt{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text);transition:background .1s;border:none;background:none;width:100%;text-align:left}
.theme-opt:hover{background:var(--surfaceHover)}
.theme-opt.active{background:var(--surface);color:var(--textStrong);font-weight:600}
.theme-opt-icon{font-size:16px;width:22px;text-align:center}
.theme-opt-swatch{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);flex-shrink:0}
.last-update{font-size:11px;color:var(--dim)}

/* Glass card */
.glass{background:var(--surface);border:1px solid var(--border);border-radius:12px;transition:background .15s}
.glass:hover{background:var(--surfaceHover)}

/* Alerts */
.alerts-section{margin-bottom:16px}
.alert-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:6px}
.alert-critical{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2)}
.alert-high{background:rgba(251,146,60,.06);border:1px solid rgba(251,146,60,.15)}
.alert-medium{background:rgba(250,204,21,.06);border:1px solid rgba(250,204,21,.1)}
.alert-low{background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.1)}
.alert-icon{font-size:16px}
.alert-msg{font-size:12px;color:var(--text);flex:1}

/* System health row */
.health-row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:20px}
.health-item{padding:12px 14px;text-align:center}
.health-label{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.health-value{font-size:15px;font-weight:700;color:var(--textStrong)}

/* Cost cards */
.cost-row{display:grid;grid-template-columns:1fr 1fr 1fr 2fr;gap:16px;margin-bottom:24px}
.cost-card{padding:16px;position:relative;overflow:hidden}
.cost-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(99,102,241,.4),transparent)}
.cost-label{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.cost-value{font-size:28px;font-weight:700;color:var(--textStrong)}
.cost-sub{font-size:11px;color:var(--dim);margin-top:4px}
.donut-container{display:flex;align-items:center;gap:16px;height:100%}
.donut{width:100px;height:100px;border-radius:50%;position:relative;flex-shrink:0}
.donut-hole{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:55%;height:55%;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--textStrong)}
.donut-legend{display:flex;flex-direction:column;gap:3px;overflow:hidden}
.donut-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);white-space:nowrap}
.donut-legend-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

/* Kanban removed */

/* Section header */
.section-header{display:flex;align-items:center;justify-content:space-between;padding:0 4px;margin-bottom:10px;flex-wrap:wrap;gap:8px}
.section-title{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.section-count{font-size:11px;color:var(--dim)}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px}

/* Panel */
.panel{padding:16px}

/* Tables */
.dtable{width:100%;border-collapse:separate;border-spacing:0 3px}
.dtable th{padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);font-weight:600;text-align:left;white-space:nowrap}
.dtable th.r{text-align:right}
.dtable td{padding:9px 10px;font-size:12px;color:var(--muted)}
.dtable td.r{text-align:right}
.dtable td.w{color:var(--textStrong);font-weight:500}
.dtable td.cost{color:var(--textStrong);font-weight:600}
.dtable tr.dr{background:var(--tableBg);border-radius:8px}
.dtable tr.dr:hover{background:var(--tableHover)}
.dtable tr.dr td:first-child{border-radius:8px 0 0 8px}
.dtable tr.dr td:last-child{border-radius:0 8px 8px 0}
.dtable tr.total-row td{border-top:1px solid var(--border);color:var(--muted);font-weight:600}

/* Status dot inline */
.sd{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.sd-ok{background:var(--green)}
.sd-error{background:var(--red)}
.sd-none{background:var(--dim)}
.sd-pending{background:var(--yellow)}

/* Context bar */
.ctx-bar{width:80px;height:6px;background:var(--tableBg);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle}
.ctx-fill{height:100%;border-radius:3px}

/* Usage bar */
.usage-bar{height:6px;background:var(--tableBg);border-radius:3px;overflow:hidden}
.usage-fill{height:100%;border-radius:3px}

/* Badges */
.badge{font-size:9px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;padding:2px 8px;border-radius:4px;white-space:nowrap}
.badge-ok{background:rgba(74,222,128,.12);color:var(--green)}
.badge-err{background:rgba(248,113,113,.12);color:var(--red)}
.badge-active{background:rgba(74,222,128,.12);color:var(--green)}
.badge-available{background:rgba(99,102,241,.12);color:var(--accent)}
.badge-none{background:var(--tableBg);color:var(--dim)}

/* Tab buttons */
.tab-group{display:flex;gap:4px}
.tab-btn{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--dim);transition:all .15s}
.tab-btn.active{background:rgba(99,102,241,.15);color:var(--accent);border-color:rgba(99,102,241,.3)}
.tab-btn.active-purple{background:rgba(168,85,247,.15);color:var(--purple);border-color:rgba(168,85,247,.3)}

/* Models grid */
.models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.model-card{padding:12px;text-align:center}
.model-name{font-size:13px;color:var(--textStrong);font-weight:600;margin-top:4px}
.model-id{font-size:10px;color:var(--dim);margin-top:3px;word-break:break-all}

/* Git log */
.git-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.git-item:last-child{border-bottom:none}
.git-hash{font-family:'SF Mono',Monaco,monospace;font-size:12px;color:var(--purple);font-weight:500;flex-shrink:0}
.git-msg{font-size:12px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}
.git-ago{font-size:10px;color:var(--dim);white-space:nowrap;flex-shrink:0}

/* Skills */
.skill-tag{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid;display:inline-block}
.tree-root{display:flex;flex-direction:column;gap:8px}
.tree-node-card{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);border-left:3px solid var(--node-color,var(--accent));transition:background .15s}
.tree-node-card:hover{background:var(--glass)}
.tree-dot{width:10px;height:10px;border-radius:50%;background:var(--node-color,var(--accent));flex-shrink:0}
.tree-name{font-size:12px;font-weight:600;color:var(--textStrong);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tree-trigger{font-size:10px;color:var(--node-color,var(--accent));opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.tree-model{font-size:10px;color:var(--dim);white-space:nowrap}
.tree-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600;flex-shrink:0}
.tree-badge.live{background:rgba(74,222,128,.12);color:var(--green);border:1px solid rgba(74,222,128,.25)}
.tree-badge.idle{background:var(--glass);color:var(--dim);border:1px solid var(--border)}
.tree-children{margin-left:20px;padding-left:14px;border-left:1px solid var(--border);margin-top:4px;display:flex;flex-direction:column;gap:4px}
.tree-grandchildren{margin-left:16px;padding-left:12px;border-left:1px dashed var(--border);margin-top:4px;display:flex;flex-direction:column;gap:4px}

/* Tooltip */
[data-tip]{position:relative;cursor:help}
[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:var(--bg);color:var(--text);padding:6px 10px;border-radius:6px;font-size:11px;white-space:pre-wrap;max-width:300px;z-index:10;border:1px solid var(--border);pointer-events:none}

/* Type badge */
.type-badge{font-size:9px;padding:1px 6px;border-radius:3px;font-weight:500;text-transform:uppercase;letter-spacing:.05em}
.type-dm{background:rgba(99,102,241,.12);color:var(--accent)}
.type-group{background:rgba(74,222,128,.12);color:var(--green)}
.type-cron{background:rgba(250,204,21,.12);color:var(--yellow)}
.type-subagent{background:rgba(168,85,247,.12);color:var(--purple)}
.type-main{background:var(--tableBg);color:var(--muted)}
.type-telegram{background:rgba(99,102,241,.12);color:var(--accent)}

.charts-section{margin-bottom:24px}
.chart-toggle{background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:8px;color:var(--muted);font-size:12px;cursor:pointer;transition:all .15s}
.chart-toggle:hover{background:var(--surfaceHover);color:var(--textStrong)}
.chart-container{padding:16px}
.chart-title{font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--muted);margin-bottom:10px}
.chart-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chart-legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted)}
.chart-legend-dot{width:8px;height:8px;border-radius:2px}
.empty{text-align:center;padding:24px;color:var(--dim);font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--scrollThumb);border-radius:2px}

@media(max-width:1024px){.cost-row{grid-template-columns:repeat(2,1fr)}.health-row{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}.cost-row.health-row{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="container">

<!-- 1. Header Bar -->
<div class="header">
  <div class="header-left">
    <div class="avatar" id="botEmoji">‚ö°</div>
    <div>
      <div class="header-title" id="botName">OpenClaw Dashboard</div>
      <div class="header-status">
        <span class="dot dot-on pulse" id="statusDot"></span>
        <span style="color:var(--green);font-weight:500" id="statusText">Online</span>
      </div>
    </div>
  </div>
  <div class="header-right">
    <a href="https://github.com/mudrii/openclaw-dashboard" target="_blank" title="View on GitHub" style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--dim);text-decoration:none;opacity:0.7;transition:opacity 0.2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      v2.7.0
    </a>
    <span class="countdown" id="countdown">60s</span>
    <span class="last-update" id="lastUpdate"></span>
    <div class="theme-picker">
      <button class="theme-btn" id="themeBtn" onclick="toggleThemeMenu()" title="Change theme">üé®</button>
      <div class="theme-menu" id="themeMenu"></div>
    </div>
    <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
  </div>
</div>

<!-- 2. Alerts Banner -->
<div class="alerts-section" id="alertsSection"></div>

<!-- 3. System Health Row -->
<div class="health-row" id="healthRow">
  <div class="glass health-item"><div class="health-label">Gateway</div><div class="health-value" id="hGw">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">PID</div><div class="health-value" id="hPid">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Uptime</div><div class="health-value" id="hUp">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Memory</div><div class="health-value" id="hMem">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Compaction</div><div class="health-value" id="hComp">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Active Sessions</div><div class="health-value" id="hSess">‚Äî</div></div>
</div>

<!-- 4. Cost Row -->
<div class="cost-row">
  <div class="glass cost-card">
    <div class="cost-label">Today's Cost</div>
    <div class="cost-value" id="cToday">‚Äî</div>
    <div class="cost-sub" id="cTodaySub"></div>
  </div>
  <div class="glass cost-card">
    <div class="cost-label">All-Time Cost</div>
    <div class="cost-value" id="cAll">‚Äî</div>
    <div class="cost-sub" id="cAllSub"></div>
  </div>
  <div class="glass cost-card">
    <div class="cost-label">Projected Monthly</div>
    <div class="cost-value" id="cProj">‚Äî</div>
    <div class="cost-sub">Based on today's rate</div>
  </div>
  <div class="glass cost-card" style="padding:12px 16px">
    <div class="cost-label" style="margin-bottom:8px">Cost Breakdown</div>
    <div class="donut-container">
      <div class="donut" id="donut"><div class="donut-hole" id="donutCenter">$0</div></div>
      <div class="donut-legend" id="donutLegend"></div>
    </div>
  </div>
</div>


<!-- 5. Charts Section -->
<div class="charts-section">
  <div class="section-header">
    <span class="section-title">üìà Charts & Trends</span>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="tab-group" id="chartTabGroup">
        <button class="tab-btn active" id="cTab7" onclick="chartDays=7;renderCharts()">7 Days</button>
        <button class="tab-btn" id="cTab30" onclick="chartDays=30;renderCharts()">30 Days</button>
      </div>
      <!-- toggle removed -->
    </div>
  </div>
  <div id="chartsContainer">
    <div class="grid-3">
      <div class="glass chart-container"><div class="chart-title">Daily Cost Trend</div><div id="costChart"></div></div>
      <div class="glass chart-container"><div class="chart-title">Cost by Model</div><div id="modelChart"></div></div>
      <div class="glass chart-container"><div class="chart-title">Sub-Agent Activity</div><div id="subagentChart"></div></div>
    </div>
  </div>
</div>

<!-- 6. Cron Jobs Panel -->
<div style="margin-bottom:24px">
  <div class="section-header"><span class="section-title">‚è∞ Cron Jobs</span><span class="section-count" id="cronCount"></span></div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable" id="cronTable">
      <thead><tr><th>Status</th><th>Name</th><th>Schedule</th><th>Last Run</th><th>Next Run</th><th class="r">Duration</th><th>Model</th></tr></thead>
      <tbody id="cronBody"></tbody>
    </table>
  </div>
</div>

<!-- 7. Active Sessions Panel -->
<div style="margin-bottom:24px">
  <div class="section-header"><span class="section-title">üì° Active Sessions</span><span class="section-count" id="sessCount"></span></div>
  <!-- Agent Hierarchy Tree -->
  <div class="card" style="margin-bottom:16px">
    <div style="font-size:11px;color:var(--dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:.05em">Agent Hierarchy</div>
    <div id="agentTree"></div>
  </div>
  <div class="glass panel" style="overflow-x:auto;max-height:400px;overflow-y:auto">
    <table class="dtable">
      <thead><tr><th>Name</th><th>Model</th><th>Type</th><th>Context %</th><th>Last Activity</th><th class="r">Tokens</th></tr></thead>
      <tbody id="sessBody"></tbody>
    </table>
  </div>
</div>

<!-- 8. Token Usage Table -->
<div style="margin-bottom:24px">
  <div class="section-header">
    <span class="section-title">üìä Token Usage & Cost</span>
    <div class="tab-group">
      <button class="tab-btn active" id="uTabT" onclick="uTab='today';render()">Today</button>
      <button class="tab-btn" id="uTab7" onclick="uTab='7d';render()">7 Days</button>
      <button class="tab-btn" id="uTab30" onclick="uTab='30d';render()">30 Days</button>
      <button class="tab-btn" id="uTabA" onclick="uTab='all';render()">All Time</button>
    </div>
  </div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable">
      <thead><tr><th>Model</th><th class="r">Calls</th><th class="r">Input</th><th class="r">Output</th><th class="r">Cache</th><th class="r">Total</th><th class="r">Cost</th><th style="min-width:100px">Usage</th></tr></thead>
      <tbody id="uBody"></tbody>
    </table>
  </div>
</div>

<!-- 9. Sub-Agent Usage Table -->
<div style="margin-bottom:24px">
  <div class="section-header">
    <span class="section-title" style="color:var(--purple)">ü§ñ Sub-Agent Activity</span>
    <div style="display:flex;align-items:center;gap:12px">
      <span id="subCostLbl" style="font-size:12px;color:var(--muted);font-weight:500"></span>
      <div class="tab-group">
        <button class="tab-btn active-purple" id="srTabT" onclick="srTab='today';render()">Today</button>
        <button class="tab-btn" id="srTab7" onclick="srTab='7d';render()">7 Days</button>
        <button class="tab-btn" id="srTab30" onclick="srTab='30d';render()">30 Days</button>
        <button class="tab-btn" id="srTabA" onclick="srTab='all';render()">All Time</button>
      </div>
    </div>
  </div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable">
      <thead><tr><th>Task</th><th>Model</th><th class="r">Cost</th><th class="r">Duration</th><th>Status</th><th>Time</th></tr></thead>
      <tbody id="srBody"></tbody>
    </table>
    <div class="empty" id="srEmpty" style="display:none">No sub-agent runs</div>
  </div>
  <!-- Sub-agent token breakdown -->
  <div style="margin-top:12px">
    <div class="section-header">
      <span class="section-title" style="color:var(--purple)">Sub-Agent Token Breakdown</span>
      <div class="tab-group">
        <button class="tab-btn active-purple" id="stTabT" onclick="stTab='today';render()">Today</button>
        <button class="tab-btn" id="stTab7" onclick="stTab='7d';render()">7 Days</button>
        <button class="tab-btn" id="stTab30" onclick="stTab='30d';render()">30 Days</button>
        <button class="tab-btn" id="stTabA" onclick="stTab='all';render()">All Time</button>
      </div>
    </div>
    <div class="glass panel" style="overflow-x:auto">
      <table class="dtable">
        <thead><tr><th>Model</th><th class="r">Calls</th><th class="r">Input</th><th class="r">Output</th><th class="r">Cache</th><th class="r">Total</th><th class="r">Cost</th><th style="min-width:100px">Usage</th></tr></thead>
        <tbody id="stBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 10. Bottom Row -->
<div class="grid-3">
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üß† Available Models</span></div>
    <div class="models-grid" id="modelsGrid"></div>
  </div>
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üîß Skills</span></div>
    <div style="display:flex;flex-wrap:wrap;gap:5px" id="skillsGrid"></div>
  </div>
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üìú Git Log</span></div>
    <div id="gitPanel"></div>
  </div>
</div>

<!-- 11. Agent Configuration -->
<div class="glass panel" style="margin-top:16px">
  <div class="section-header">
    <span class="section-title">‚öôÔ∏è Agent &amp; Model Configuration</span>
    <span class="section-count" id="agentCount"></span>
  </div>

  <!-- Agent Cards Row -->
  <div id="agentCards" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px"></div>

  <!-- 2-col: Model Routing + Runtime Config -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px">
    <!-- Model Routing -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üîÄ Model Routing</div>
      <div id="modelRoutingPanel"></div>
    </div>
    <!-- Runtime Config -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üõ†Ô∏è Runtime Config</div>
      <div id="runtimeConfigPanel"></div>
    </div>
  </div>

  <!-- 3-col: Search + Gateway + Capabilities -->
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:18px" id="extraConfigRow">

    <!-- Search -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px" id="searchPanel">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üîç Web Search</div>
      <div id="searchPanelInner"></div>
    </div>

    <!-- Gateway -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px" id="gatewayPanel">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üåê Gateway</div>
      <div id="gatewayPanelInner"></div>
    </div>

    <!-- Subagent Limits -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px" id="subagentLimitsCell">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üï∏Ô∏è Subagent Limits</div>
      <div id="subagentConfigPanel"></div>
    </div>

    <!-- Hooks -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px" id="hooksPanel">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">ü™ù Internal Hooks</div>
      <div id="hooksPanelInner"></div>
    </div>

    <!-- Plugins & Capabilities -->
    <div style="background:var(--glass);border:1px solid var(--border);border-radius:8px;padding:12px" id="capsPanel">
      <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">üîå Plugins & Extras</div>
      <div id="capsPanelInner"></div>
    </div>

  </div>

  <!-- Agent Bindings -->
  <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px">üîó Agent Bindings</div>
  <div id="bindingsPanel" style="margin-bottom:16px"></div>

  <!-- Full Agent Table -->
  <div style="font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px">üìã Agent Details</div>
  <div style="overflow-x:auto">
  <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:700px" id="agentTable">
    <thead>
      <tr style="color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:.08em">
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Agent ID</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Role</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Model</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Provider</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Workspace</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Fallbacks</th>
        <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border)">Context 1M</th>
      </tr>
    </thead>
    <tbody id="agentTableBody"></tbody>
  </table>
  </div>

  <!-- subagentConfigPanel moved to extraConfigRow grid -->
</div>

<div style="text-align:center;padding:12px;font-size:10px;color:var(--darker)">OpenClaw Dashboard ¬∑ Auto-refresh 60s</div>
</div>

<script>
// ‚îÄ‚îÄ Theme Engine ‚îÄ‚îÄ
let THEMES={},currentTheme='midnight';

async function loadThemes(){
  try{
    const r=await fetch('/themes.json?t='+Date.now());
    THEMES=await r.json();
  }catch(e){console.warn('themes.json not found, using defaults');return}
  const saved=localStorage.getItem('ocDashTheme');
  if(saved&&THEMES[saved])currentTheme=saved;
  applyTheme(currentTheme);
  renderThemeMenu();
}

function applyTheme(id){
  const t=THEMES[id];if(!t)return;
  currentTheme=id;
  const root=document.documentElement;
  const c=t.colors;
  root.style.setProperty('--bg',c.bg);
  root.style.setProperty('--surface',c.surface);
  root.style.setProperty('--surfaceHover',c.surfaceHover);
  root.style.setProperty('--border',c.border);
  root.style.setProperty('--accent',c.accent);
  root.style.setProperty('--accent2',c.accent2);
  root.style.setProperty('--green',c.green);
  root.style.setProperty('--yellow',c.yellow);
  root.style.setProperty('--red',c.red);
  root.style.setProperty('--orange',c.orange);
  root.style.setProperty('--purple',c.purple);
  root.style.setProperty('--text',c.text);
  root.style.setProperty('--textStrong',c.textStrong);
  root.style.setProperty('--muted',c.muted);
  root.style.setProperty('--dim',c.dim);
  root.style.setProperty('--darker',c.darker);
  root.style.setProperty('--tableBg',c.tableBg);
  root.style.setProperty('--tableHover',c.tableHover);
  root.style.setProperty('--scrollThumb',c.scrollThumb);
  localStorage.setItem('ocDashTheme',id);
  renderThemeMenu();
}

function renderThemeMenu(){
  const menu=$('themeMenu');if(!menu)return;
  const darkThemes=Object.entries(THEMES).filter(([,t])=>t.type==='dark');
  const lightThemes=Object.entries(THEMES).filter(([,t])=>t.type==='light');
  let html='<div class="theme-menu-label">Dark Themes</div>';
  darkThemes.forEach(([id,t])=>{
    html+=`<button class="theme-opt${id===currentTheme?' active':''}" onclick="applyTheme('${esc(id)}');event.stopPropagation()"><span class="theme-opt-icon">${esc(t.icon)}</span><span>${esc(t.name)}</span><span class="theme-opt-swatch" style="background:${safeColor(t.colors.accent)};margin-left:auto"></span></button>`;
  });
  html+='<div class="theme-menu-label" style="margin-top:4px">Light Themes</div>';
  lightThemes.forEach(([id,t])=>{
    html+=`<button class="theme-opt${id===currentTheme?' active':''}" onclick="applyTheme('${esc(id)}');event.stopPropagation()"><span class="theme-opt-icon">${esc(t.icon)}</span><span>${esc(t.name)}</span><span class="theme-opt-swatch" style="background:${safeColor(t.colors.accent)};margin-left:auto"></span></button>`;
  });
  menu.innerHTML=html;
}

function toggleThemeMenu(){
  const menu=$('themeMenu');
  menu.classList.toggle('open');
}
document.addEventListener('click',e=>{
  const picker=document.querySelector('.theme-picker');
  if(picker&&!picker.contains(e.target)){$('themeMenu').classList.remove('open')}
});

loadThemes();

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
let D={},uTab='today',srTab='today',stTab='today',timer=60;
const COLORS=['#6366f1','#9333ea','#ec4899','#f59e0b','#10b981','#06b6d4','#f87171','#84cc16'];
const $=id=>document.getElementById(id);
const esc = s => String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
function safeColor(v){
  return /^#[0-9a-fA-F]{3,8}$/.test(v||'') ? v : '#888888';
}

function relTime(ts){
  if(!ts)return'‚Äî';
  let d;
  if(typeof ts==='number')d=new Date(ts);
  else{d=new Date(ts);if(isNaN(d))return ts}
  const diff=Math.floor((Date.now()-d)/1000);
  if(diff<60)return diff+'s ago';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

async function loadData(){
  try{
    const r=await fetch('/api/refresh?t='+Date.now());
    D=await r.json();render();
    $('lastUpdate').textContent='Updated: '+new Date().toLocaleTimeString();
    timer=60;
  }catch(e){
    $('alertsSection').innerHTML='<div class="alert-item alert-critical"><span class="alert-icon">‚ö†Ô∏è</span><span class="alert-msg">Failed to load data.json</span></div>';
  }
}

function render(){
  const gw=D.gateway||{};
  const on=gw.status==='online';

  // Header
  $('botName').textContent=D.botName||'OpenClaw Dashboard';
  $('botEmoji').textContent=D.botEmoji||'‚ö°';
  document.title=D.botName||'OpenClaw Dashboard';
  $('statusDot').className='dot '+(on?'dot-on pulse':'dot-off');
  $('statusText').textContent=on?'Online':'Offline';
  $('statusText').style.color=on?'var(--green)':'var(--red)';

  // Alerts
  const alerts=D.alerts||[];
  $('alertsSection').innerHTML=alerts.length?alerts.map(a=>`<div class="alert-item alert-${esc(a.severity)||'low'}"><span class="alert-icon">${esc(a.icon)||'‚ÑπÔ∏è'}</span><span class="alert-msg">${esc(a.message)}</span></div>`).join(''):'';

  // Health
  $('hGw').innerHTML=on?'<span style="color:var(--green)">‚óè</span> Online':'<span style="color:var(--red)">‚óè</span> Offline';
  $('hGw').style.color='var(--textStrong)';
  $('hPid').textContent=gw.pid||'‚Äî';
  $('hUp').textContent=gw.uptime||'‚Äî';
  $('hMem').textContent=gw.memory||'‚Äî';
  $('hComp').textContent=D.compactionMode||'‚Äî';
  $('hSess').textContent=D.sessionCount||0;

  // Cost
  $('cToday').textContent='$'+(D.totalCostToday||0).toFixed(2);
  $('cTodaySub').textContent='Sub-agents: $'+(D.subagentCostToday||0).toFixed(2);
  $('cAll').textContent='$'+(D.totalCostAllTime||0).toFixed(2);
  $('cAllSub').textContent='Sub-agents: $'+(D.subagentCostAllTime||0).toFixed(2);
  $('cProj').textContent='$'+(D.projectedMonthly||0).toFixed(0);

  // Donut (CSS conic-gradient)
  const bd=D.costBreakdown||[];
  const total=bd.reduce((a,d)=>a+d.cost,0)||1;
  let grad='',cum=0,legend='';
  bd.forEach((d,i)=>{
    const pct=d.cost/total*100;
    const c=COLORS[i%COLORS.length];
    grad+=`${c} ${cum}% ${cum+pct}%,`;
    cum+=pct;
    legend+=`<div class="donut-legend-item"><span class="donut-legend-dot" style="background:${c}"></span>${esc(d.model)} $${d.cost.toFixed(0)} (${Math.round(pct)}%)</div>`;
  });
  $('donut').style.background=`conic-gradient(${grad.slice(0,-1)})`;
  $('donutCenter').textContent='$'+total.toFixed(0);
  $('donutLegend').innerHTML=legend;


  const crons=D.crons||[];
  $('cronCount').textContent=crons.length+' jobs';
  $('cronBody').innerHTML=crons.map(c=>{
    const st=c.lastStatus;
    const dotCls=st==='ok'?'sd-ok':st==='error'?'sd-error':st==='none'?'sd-none':'sd-pending';
    const tip=c.lastError?` data-tip="${esc(c.lastError)}"`:'';
    const dur=c.lastDurationMs?((c.lastDurationMs/1000).toFixed(1)+'s'):'‚Äî';
    return `<tr class="dr"><td><span class="sd ${dotCls}"${tip}></span>${esc(st)||'‚Äî'}</td><td class="w">${esc(c.name)}</td><td>${esc(c.schedule)}</td><td>${esc(c.lastRun||'‚Äî')}</td><td>${esc(c.nextRun||'‚Äî')}</td><td class="r">${dur}</td><td>${esc(c.model||'‚Äî')}</td></tr>`;
  }).join('');

  // Sessions
  const sess=(D.sessions||[]).slice(0,20);
  $('sessCount').textContent=(D.sessionCount||sess.length)+' total, '+sess.length+' shown';
  $('sessBody').innerHTML=sess.map(s=>{
    const pct=s.contextPct||0;
    const color=pct>80?'var(--red)':pct>50?'var(--yellow)':'var(--green)';
    const typeCls='type-'+(esc(s.type)||'main');
    return `<tr class="dr"><td class="w" style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.name)}</td><td>${esc(s.model)}</td><td><span class="type-badge ${typeCls}">${esc(s.type)||'‚Äî'}</span></td><td><div class="ctx-bar"><div class="ctx-fill" style="width:${pct}%;background:${color}"></div></div> <span style="font-size:11px;color:${color}">${pct}%</span></td><td>${relTime(s.updatedAt)}</td><td class="r">${(s.totalTokens||0).toLocaleString()}</td></tr>`;
  }).join('');

  // Token usage
  setTabCls4('uTab',uTab,'active');
  const uData=uTab==='today'?D.tokenUsageToday:uTab==='7d'?D.tokenUsage7d:uTab==='30d'?D.tokenUsage30d:D.tokenUsage;
  renderTokenTbl('uBody',uData,'var(--accent)');

  // Sub runs
  setTabCls4('srTab',srTab,'active-purple');
  const runs=srTab==='today'?(D.subagentRunsToday||[]):srTab==='7d'?(D.subagentRuns7d||[]):srTab==='30d'?(D.subagentRuns30d||[]):(D.subagentRuns||[]);
  const srCost=srTab==='today'?(D.subagentCostToday||0):srTab==='7d'?(D.subagentCost7d||0):srTab==='30d'?(D.subagentCost30d||0):(D.subagentCostAllTime||0);
  $('subCostLbl').textContent='Total: $'+srCost.toFixed(2);
  $('srEmpty').style.display=runs.length?'none':'block';
  $('srBody').innerHTML=runs.slice(0,20).map(r=>{
    const dur=r.durationSec>=3600?(r.durationSec/3600).toFixed(1)+'h':r.durationSec>=60?Math.round(r.durationSec/60)+'m':r.durationSec+'s';
    return `<tr class="dr"><td class="w" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.task)}</td><td>${esc(r.model)}</td><td class="r cost">$${r.cost.toFixed(4)}</td><td class="r">${dur}</td><td><span class="badge badge-ok">${esc(r.status)}</span></td><td>${esc(r.timestamp)}</td></tr>`;
  }).join('');

  // Sub token
  setTabCls4('stTab',stTab,'active-purple');
  const stData=stTab==='today'?D.subagentUsageToday:stTab==='7d'?D.subagentUsage7d:stTab==='30d'?D.subagentUsage30d:D.subagentUsage;
  renderTokenTbl('stBody',stData,'var(--purple)');

  // Charts
  renderCharts();
  renderAgentTree();

  // Models
  $('modelsGrid').innerHTML=(D.availableModels||[]).map(m=>`<div class="glass model-card"><span class="badge badge-${esc(m.status)}">${esc(m.status)}</span><div class="model-name">${esc(m.name)}</div><div class="model-id">${esc(m.provider)}</div></div>`).join('');

  // Agent Configuration ‚Äî fully generic, works with any number of agents/models
  const AC = D.agentConfig||{};
  // Cycle through a palette of colors for any number of agents
  const PALETTE = ['var(--green)','var(--blue)','var(--purple)','var(--yellow)','var(--cyan,#22d3ee)','var(--orange,#fb923c)'];
  const EMOJIS  = ['ü§ñ','‚öôÔ∏è','üë•','üîß','üß†','ü¶æ','üõ†Ô∏è'];

  // Agent count badge
  const agentList = AC.agents||[];
  $('agentCount').textContent = agentList.length + (agentList.length===1?' agent':' agents');

  // Agent Cards ‚Äî data-driven, no hardcoded IDs
  $('agentCards').innerHTML = agentList.length ? agentList.map((a,i)=>{
    const col = PALETTE[i % PALETTE.length];
    const em  = EMOJIS[i % EMOJIS.length];
    const provider = (a.modelId||'').split('/')[0]||'‚Äî';
    return `<div style="background:var(--glass);border:1px solid var(--border);border-left:3px solid ${col};border-radius:8px;padding:12px 14px;min-width:180px;flex:1">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
        <span style="font-size:16px">${em}</span>
        <span style="font-size:13px;font-weight:700;color:var(--textStrong)">${esc(a.id)}</span>
        ${a.isDefault?'<span style="font-size:9px;background:rgba(74,222,128,.15);color:var(--green);border:1px solid rgba(74,222,128,.3);border-radius:4px;padding:1px 5px">DEFAULT</span>':''}
      </div>
      <div style="font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:2px">Role</div>
      <div style="font-size:13px;color:${col};font-weight:600;margin-bottom:8px">${esc(a.role||a.id)}</div>
      <div style="font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:2px">Model</div>
      <div style="font-size:13px;color:var(--textStrong);font-weight:600;margin-bottom:2px">${esc(a.model||'‚Äî')}</div>
      <div style="font-size:11px;color:var(--dim);font-family:monospace">${esc(provider)}</div>
    </div>`;
  }).join('') : '<div style="color:var(--dim);font-size:11px;padding:8px">No agents configured ‚Äî using default model.</div>';

  // Model Routing Panel ‚Äî generic, handles 0‚ÄìN fallbacks
  const fallbacks = AC.fallbacks||[];
  const routingChain = [
    {label:'PRIMARY', model:AC.primaryModel||'‚Äî', color:'rgba(74,222,128,.3)', bg:'rgba(74,222,128,.1)', textCol:'var(--green)'},
    ...fallbacks.map((f,i)=>({label:`FALLBACK ${i+1}`, model:f, color:'var(--border)', bg:'var(--glass)', textCol:'var(--text)', opacity:Math.max(0.5,1-i*0.15)}))
  ];
  const extraRows = [
    AC.imageModel ? {k:'üñºÔ∏è Image Model', v:AC.imageModel, c:'var(--purple)'} : null,
    AC.streamMode ? {k:'üì° Stream Mode', v:AC.streamMode, c:'var(--blue)'} : null,
  ].filter(Boolean);
  // Sub-agent routing ‚Äî all agents including main
  const subAgentRoutes = agentList.map((a,i)=>{
    const col=PALETTE[i%PALETTE.length];
    const purposeMap={'main':'üß† General / Default','group':'üñ•Ô∏è Dev / Coding','work':'‚öôÔ∏è Work / Admin'};
    const purpose=purposeMap[a.id]||`ü§ñ ${a.id}`;
    return {purpose, agent:a.id, model:a.model, col, isDefault:a.isDefault};
  });
  $('modelRoutingPanel').innerHTML = `
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">General</div>
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:${extraRows.length||subAgentRoutes.length?'10':'0'}px">
      ${routingChain.map((r,i)=>`
        ${i>0?'<div style="color:var(--dim);font-size:12px">‚Üí</div>':''}
        <div style="background:${r.bg};border:1px solid ${r.color};border-radius:6px;padding:5px 9px;text-align:center${r.opacity?`;opacity:${r.opacity}`:''}">
          <div style="font-size:9px;color:var(--muted);margin-bottom:1px">${r.label}</div>
          <div style="font-size:13px;font-weight:700;color:${r.textCol}">${esc(r.model)}</div>
        </div>`).join('')}
    </div>
    ${subAgentRoutes.length?`<div style="padding-top:8px;border-top:1px solid var(--border);margin-bottom:${extraRows.length?'8':'0'}px">
      <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Sub-agent Routing</div>
      ${subAgentRoutes.map(r=>`
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <span style="font-size:12px;color:var(--dim);min-width:130px">${esc(r.purpose)}</span>
          <span style="color:var(--dim);font-size:11px">‚Üí</span>
          <span style="background:var(--glass);border:1px solid var(--border);border-left:3px solid ${r.col};border-radius:5px;padding:3px 8px;font-size:12px;font-weight:700;color:${r.col}">${esc(r.model)}</span>
          <span style="font-size:10px;color:var(--dim)">(${esc(r.agent)} agent)</span>
        </div>`).join('')}
    </div>`:''}
    ${extraRows.length?`<div style="padding-top:8px;border-top:1px solid var(--border)">${
      extraRows.map(r=>`<div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:12px;color:var(--muted)">${esc(r.k)}</span>
        <span style="font-size:12px;color:${r.c};font-weight:600">${esc(r.v)}</span>
      </div>`).join('')
    }</div>`:''}`.trim();

  // Runtime Config Panel ‚Äî only show rows that have actual data
  const comp = AC.compaction||{};
  const compCards = [
    comp.mode                      ? {k:'Compaction Mode',  v:comp.mode,                                         c:'var(--yellow)'} : null,
    comp.reserveTokensFloor        ? {k:'Reserve Tokens',   v:comp.reserveTokensFloor.toLocaleString(),           c:'var(--text)'}   : null,
    comp.memoryFlush!=null         ? {k:'Memory Flush',     v:comp.memoryFlush?.enabled?'Enabled':'Disabled',     c:comp.memoryFlush?.enabled?'var(--green)':'var(--dim)'} : null,
    comp.softThresholdTokens       ? {k:'Soft Threshold',   v:comp.softThresholdTokens.toLocaleString()+' tok',   c:'var(--text)'}   : null,
  ].filter(Boolean);
  const channelRows = [
    (AC.channels||[]).length       ? {k:'Active Channels',    v:(AC.channels).join(', ')}                        : null,
    AC.telegramDmPolicy            ? {k:'Telegram DM Policy', v:AC.telegramDmPolicy}                             : null,
    AC.telegramGroups              ? {k:'Telegram Groups',    v:AC.telegramGroups+' configured'}                 : null,
  ].filter(Boolean);
  $('runtimeConfigPanel').innerHTML = [
    compCards.length ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin-bottom:${channelRows.length?8:0}px">
      ${compCards.map(r=>`<div style="background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:5px;padding:6px 8px">
        <div style="font-size:9px;color:var(--muted);margin-bottom:2px">${esc(r.k)}</div>
        <div style="font-size:12px;font-weight:600;color:${r.c}">${esc(r.v)}</div>
      </div>`).join('')}
    </div>` : '',
    channelRows.length ? `<div style="${compCards.length?'padding-top:8px;border-top:1px solid var(--border)':''}">
      ${channelRows.map(r=>`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span style="font-size:12px;color:var(--muted);min-width:140px">${esc(r.k)}</span>
        <span style="font-size:12px;color:var(--text);font-weight:600">${esc(r.v)}</span>
      </div>`).join('')}
    </div>` : '',
    !compCards.length && !channelRows.length ? '<div style="color:var(--dim);font-size:11px">No runtime config detected.</div>' : ''
  ].join('');

  // Helper: key-value row
  const kv = (k,v,c='var(--text)') => `<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:var(--muted)">${esc(k)}</span><span style="font-size:12px;color:${c};font-weight:600">${esc(String(v))}</span></div>`;
  const badge = (label,on) => `<span style="display:inline-block;margin:2px 2px;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;background:${on?'rgba(74,222,128,.12)':'rgba(255,255,255,.05)'};color:${on?'var(--green)':'var(--dim)'};border:1px solid ${on?'rgba(74,222,128,.3)':'var(--border)'}">${esc(label)}</span>`;

  // Search Panel
  const SR = AC.search||{};
  $('searchPanelInner').innerHTML = SR.provider ? [
    kv('Provider', SR.provider, 'var(--blue)'),
    kv('Max Results', SR.maxResults),
    kv('Cache TTL', (SR.cacheTtlMinutes||'‚Äî')+' min'),
  ].join('') : '<span style="color:var(--dim);font-size:12px">Not configured</span>';

  // Gateway Panel
  const GW = AC.gateway||{};
  $('gatewayPanelInner').innerHTML = GW.port ? [
    kv('Port', GW.port, 'var(--green)'),
    kv('Mode', GW.mode),
    kv('Bind', GW.bind),
    kv('Auth Mode', GW.authMode),
    kv('Tailscale', GW.tailscale),
  ].join('') : '<span style="color:var(--dim);font-size:12px">Not configured</span>';

  // Hooks Panel
  const hooks = AC.hooks||[];
  $('hooksPanelInner').innerHTML = hooks.length
    ? hooks.map(h=>badge(h.name, h.enabled)).join('')
    : '<span style="color:var(--dim);font-size:12px">No hooks configured</span>';

  // Plugins & Extras
  const plugins = AC.plugins||[];
  const skills  = (AC.skills||[]).filter(s=>s.enabled);
  $('capsPanelInner').innerHTML = [
    plugins.length ? `<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--muted);margin-bottom:3px">Plugins</div>${plugins.map(p=>badge(p,true)).join('')}</div>` : '',
    skills.length  ? `<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--muted);margin-bottom:3px">Active Skills</div>${skills.map(s=>badge(s.name,true)).join('')}</div>` : '',
    `<div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
      ${badge('TTS', AC.tts)}
      ${badge('Diagnostics', AC.diagnostics)}
    </div>`,
  ].join('');

  // Bindings
  const bindings = AC.bindings||[];
  const agentColMap={};agentList.forEach((a,i)=>agentColMap[a.id]=PALETTE[i%PALETTE.length]);
  $('bindingsPanel').innerHTML = bindings.length
    ? `<div style="display:flex;flex-wrap:wrap;gap:8px">${bindings.map(b=>{
        const col=agentColMap[b.agentId]||'var(--dim)';
        const isDefault=b.kind==='default';
        const displayName=b.name||(isDefault?'All unmatched channels':b.id);
        const icon=isDefault?'üåê':b.channel==='telegram'?'‚úàÔ∏è':'üì°';
        return `<div style="background:var(--glass);border:1px solid var(--border);border-left:3px solid ${col};border-radius:6px;padding:8px 12px;min-width:180px">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
            <span style="font-size:12px">${icon}</span>
            <span style="font-size:12px;font-weight:700;color:${col}">${esc(b.agentId)}</span>
            ${isDefault?'<span style="font-size:9px;background:rgba(74,222,128,.12);color:var(--green);border:1px solid rgba(74,222,128,.25);border-radius:3px;padding:1px 4px">DEFAULT</span>':''}
          </div>
          <div style="font-size:13px;font-weight:600;color:var(--textStrong)">${esc(displayName)}</div>
          ${!isDefault?`<div style="font-size:10px;color:var(--dim);margin-top:2px;font-family:monospace">${esc(b.channel)} ¬∑ ${esc(b.kind)} ¬∑ ${esc(b.id)}</div>`:'<div style="font-size:10px;color:var(--dim);margin-top:2px">catch-all fallback</div>'}
        </div>`;
      }).join('')}</div>`
    : '<span style="color:var(--dim);font-size:12px">No explicit bindings ‚Äî all messages go to default agent</span>';

    // Subagent config panel
  const SC=AC.subagentConfig||{};
  $('subagentConfigPanel').innerHTML=[
    SC.maxSpawnDepth!=null    ? kv('Max Depth',        SC.maxSpawnDepth,    'var(--accent)') : '',
    SC.maxChildrenPerAgent!=null ? kv('Max Children/Agent', SC.maxChildrenPerAgent, 'var(--text)') : '',
    SC.maxConcurrent!=null    ? kv('Max Concurrent',   SC.maxConcurrent,    'var(--text)') : '',
  ].join('')||'<span style="color:var(--dim);font-size:12px">Not configured</span>';

  // Per-agent fallbacks in table ‚Äî use agent-specific fallbacks
  $('agentTableBody').innerHTML = agentList.map((a,i)=>{
    const col = PALETTE[i % PALETTE.length];
    const provider = (a.modelId||'').split('/')[0]||'‚Äî';
    const ctx1m = a.context1m===true?'‚úÖ':a.context1m===false?'‚ùå':'‚Äî';
    const agentFallbacks = (a.fallbacks||AC.fallbacks||[]).join(' ‚Üí ');
    return `<tr class="dr">
      <td style="padding:6px 8px;font-weight:700;color:${col}">${esc(a.id)}${a.isDefault?' <span style="font-size:9px;color:var(--green);font-weight:400">(default)</span>':''}</td>
      <td style="padding:6px 8px;color:var(--text)">${esc(a.role||a.id)}</td>
      <td style="padding:6px 8px;color:var(--textStrong);font-weight:600">${esc(a.model)}</td>
      <td style="padding:6px 8px;color:var(--dim);font-size:12px">${esc(provider)}</td>
      <td style="padding:6px 8px;color:var(--dim);font-size:12px;font-family:monospace">${esc(a.workspace)}</td>
      <td style="padding:6px 8px;color:var(--dim);font-size:12px">${esc(agentFallbacks)}</td>
      <td style="padding:6px 8px;text-align:center">${ctx1m}</td>
    </tr>`;
  }).join('')||'<tr><td colspan="7" style="padding:8px;color:var(--dim)">No agents configured</td></tr>';

  // Skills
  $('skillsGrid').innerHTML=(D.skills||[]).map(s=>{
    const c=s.active?'color:var(--green);border-color:rgba(74,222,128,.2);background:rgba(74,222,128,.05)':'color:var(--dim);border-color:var(--border)';
    return `<span class="skill-tag" style="${c}">${esc(s.name)}</span>`;
  }).join('');

  // Git
  $('gitPanel').innerHTML=(D.gitLog||[]).slice(0,5).map(g=>`<div class="git-item"><span class="git-hash">${esc(g.hash)}</span><span class="git-msg" title="${esc(g.message)}">${esc(g.message)}</span><span class="git-ago">${esc(g.ago)}</span></div>`).join('')||'<div class="empty">No git history</div>';
}

function renderAgentTree(){
  const el=document.getElementById('agentTree');
  if(!el)return;
  const sessions=(D.sessions||[]).filter(s=>s.active);
  if(!sessions.length){el.innerHTML='<div style="color:var(--dim);font-size:12px;padding:8px 0">No active sessions</div>';return;}
  const COLORS={main:'var(--green)',work:'var(--accent)',group:'var(--purple)',other:'var(--dim)'};
  const byKey={};sessions.forEach(s=>byKey[s.key]=s);
  const roots=sessions.filter(s=>s.type!=='subagent');
  const subs=sessions.filter(s=>s.type==='subagent');
  const childrenOf={};
  subs.forEach(s=>{
    const pk=s.spawnedBy||'';
    if(pk&&byKey[pk])(childrenOf[pk]=childrenOf[pk]||[]).push(s);
    else(childrenOf['__unknown__']=childrenOf['__unknown__']||[]).push(s);
  });
  const trueRoots=roots.filter(r=>r.type!=='subagent');
  if((childrenOf['__unknown__']||[]).length) trueRoots.push({key:'__unknown__',name:'Unknown',agent:'other',model:'',active:false,label:'',subject:'',totalTokens:0,type:'other'});
  if(!trueRoots.length){el.innerHTML='<div style="color:var(--dim);font-size:12px;padding:8px 0">No agent hierarchy</div>';return;}
  function nodeCard(s,col){
    const name=esc((s.name||s.agent||'agent').slice(0,40));
    const model=esc((s.model||'').split('/').pop().slice(0,24));
    const trigger=esc((s.subject||s.label||'').slice(0,30));
    const badge=s.active?'<span class="tree-badge live">‚óè live</span>':'<span class="tree-badge idle">idle</span>';
    return `<div class="tree-node-card" style="--node-color:${col}">
      <div class="tree-dot"></div>
      <span class="tree-name" title="${name}">${name}</span>
      ${trigger?`<span class="tree-trigger">${trigger}</span>`:''}
      <span class="tree-model">${model}</span>
      ${badge}
    </div>`;
  }
  let html='<div class="tree-root">';
  trueRoots.forEach(r=>{
    const col=COLORS[r.agent]||COLORS.work;
    const children=childrenOf[r.key]||[];
    html+=nodeCard(r,col);
    if(children.length){
      html+='<div class="tree-children">';
      children.forEach(c=>{
        html+=nodeCard(c,col);
        const gcs=childrenOf[c.key]||[];
        if(gcs.length){
          html+='<div class="tree-grandchildren">';
          gcs.forEach(gc=>{ html+=nodeCard(gc,'var(--dim)'); });
          html+='</div>';
        }
      });
      html+='</div>';
    }
  });
  html+='</div>';
  el.innerHTML=html;
}
function renderTokenTbl(bodyId,data,accentColor){
  data=data||[];
  const max=Math.max(...data.map(u=>u.cost))||1;
  $(bodyId).innerHTML=data.map(u=>{
    const pct=Math.round(u.cost/max*100);
    return `<tr class="dr"><td class="w">${esc(u.model)}</td><td class="r">${u.calls.toLocaleString()}</td><td class="r">${u.input}</td><td class="r">${u.output}</td><td class="r">${u.cacheRead}</td><td class="r" style="color:var(--textStrong);font-weight:500">${u.totalTokens}</td><td class="r cost">$${u.cost.toFixed(2)}</td><td><div class="usage-bar"><div class="usage-fill" style="width:${pct}%;background:${accentColor}"></div></div></td></tr>`;
  }).join('')+(data.length?`<tr class="total-row"><td class="w">TOTAL</td><td class="r">${data.reduce((a,u)=>a+u.calls,0).toLocaleString()}</td><td colspan="4"></td><td class="r cost">$${data.reduce((a,u)=>a+u.cost,0).toFixed(2)}</td><td></td></tr>`:'');
}

function setTabCls4(prefix,tab,cls){
  $(prefix+'T').className='tab-btn'+(tab==='today'?' '+cls:'');
  $(prefix+'7').className='tab-btn'+(tab==='7d'?' '+cls:'');
  $(prefix+'30').className='tab-btn'+(tab==='30d'?' '+cls:'');
  $(prefix+'A').className='tab-btn'+(tab==='all'?' '+cls:'');
}

let chartDays=7;

function renderCharts(){
  $('cTab7').className='tab-btn'+(chartDays===7?' active':'');
  $('cTab30').className='tab-btn'+(chartDays===30?' active':'');
  const data=(D.dailyChart||[]).slice(-chartDays);
  if(!data.length)return;
  renderCostChart('costChart',data);
  renderModelChart('modelChart',data);
  renderSubagentChart('subagentChart',data);
}

function renderCostChart(id,data){
  const W=400,H=300,P={t:20,r:20,b:40,l:50};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;
  const maxY=Math.max(...data.map(d=>d.total))||1;
  const stepX=cw/(data.length-1||1);
  let pts=data.map((d,i)=>[P.l+i*stepX,P.t+ch-(d.total/maxY)*ch]);
  const line=pts.map((p,i)=>(i?'L':'M')+p[0]+','+p[1]).join(' ');
  const area=line+` L${pts[pts.length-1][0]},${P.t+ch} L${pts[0][0]},${P.t+ch} Z`;
  const dots=pts.map((p,i)=>`<circle cx="${p[0]}" cy="${p[1]}" r="3" fill="var(--accent)"><title>${esc(data[i].label)}: $${data[i].total.toFixed(2)}</title></circle>`).join('');
  const yLabels=Array.from({length:5},(_, i)=>{const v=maxY*i/4;const y=P.t+ch-ch*i/4;return `<text x="${P.l-6}" y="${y+3}" text-anchor="end" fill="var(--dim)" font-size="9">$${v.toFixed(0)}</text><line x1="${P.l}" y1="${y}" x2="${W-P.r}" y2="${y}" stroke="var(--border)" stroke-dasharray="2"/>`}).join('');
  const nth=Math.ceil(data.length/7);
  const xLabels=data.map((d,i)=>i%nth===0?`<text x="${P.l+i*stepX}" y="${H-P.b+16}" text-anchor="middle" fill="var(--dim)" font-size="9">${esc(d.label)}</text>`:'').join('');
  $(id).innerHTML=`<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:350px">${yLabels}${xLabels}<path d="${area}" fill="var(--accent)" opacity="0.15"/><path d="${line}" fill="none" stroke="var(--accent)" stroke-width="2"/>${dots}</svg>`;
}

function renderModelChart(id,data){
  const W=400,H=300,P={t:20,r:20,b:55,l:50};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;
  const models=new Set();data.forEach(d=>{if(d.models)Object.keys(d.models).forEach(m=>models.add(m))});
  const mList=[...models];
  const maxY=Math.max(...data.map(d=>Object.values(d.models||{}).reduce((a,v)=>a+v,0)))||1;
  const barW=cw/data.length*0.7,gap=cw/data.length*0.3;
  let bars='';
  data.forEach((d,i)=>{
    let cum=0;const x=P.l+i*(barW+gap)+gap/2;
    mList.forEach((m,mi)=>{
      const v=(d.models||{})[m]||0;const h=(v/maxY)*ch;
      bars+=`<rect x="${x}" y="${P.t+ch-cum-h}" width="${barW}" height="${h}" fill="${COLORS[mi%COLORS.length]}"><title>${esc(d.label)} ${esc(m)}: $${v.toFixed(2)}</title></rect>`;
      cum+=h;
    });
  });
  const yLabels=Array.from({length:5},(_,i)=>{const v=maxY*i/4;const y=P.t+ch-ch*i/4;return `<text x="${P.l-6}" y="${y+3}" text-anchor="end" fill="var(--dim)" font-size="9">$${v.toFixed(0)}</text><line x1="${P.l}" y1="${y}" x2="${W-P.r}" y2="${y}" stroke="var(--border)" stroke-dasharray="2"/>`}).join('');
  const nth=Math.ceil(data.length/7);
  const xLabels=data.map((d,i)=>i%nth===0?`<text x="${P.l+i*(barW+gap)+gap/2+barW/2}" y="${H-P.b+16}" text-anchor="middle" fill="var(--dim)" font-size="9">${esc(d.label)}</text>`:'').join('');
  const legend=mList.map((m,i)=>`<span class="chart-legend-item"><span class="chart-legend-dot" style="background:${COLORS[i%COLORS.length]}"></span>${esc(m)}</span>`).join('');
  $(id).innerHTML=`<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:310px">${yLabels}${xLabels}${bars}</svg><div class="chart-legend">${legend}</div>`;
}

function renderSubagentChart(id,data){
  const W=400,H=300,P={t:20,r:50,b:40,l:50};
  const cw=W-P.l-P.r,ch=H-P.t-P.b;
  const maxRuns=Math.max(...data.map(d=>d.subagentRuns||0))||1;
  const maxCost=Math.max(...data.map(d=>d.subagentCost||0))||1;
  const barW=cw/data.length*0.6,gap=cw/data.length*0.4;
  let bars='',pts=[];
  data.forEach((d,i)=>{
    const x=P.l+i*(barW+gap)+gap/2;
    const h=((d.subagentRuns||0)/maxRuns)*ch;
    bars+=`<rect x="${x}" y="${P.t+ch-h}" width="${barW}" height="${h}" fill="var(--purple)" opacity="0.6"><title>${esc(d.label)}: ${d.subagentRuns||0} runs</title></rect>`;
    pts.push([x+barW/2,P.t+ch-((d.subagentCost||0)/maxCost)*ch]);
  });
  const line=pts.map((p,i)=>(i?'L':'M')+p[0]+','+p[1]).join(' ');
  const dots=pts.map((p,i)=>`<circle cx="${p[0]}" cy="${p[1]}" r="3" fill="var(--accent)"><title>${esc(data[i].label)}: $${(data[i].subagentCost||0).toFixed(2)}</title></circle>`).join('');
  const yL=Array.from({length:5},(_,i)=>{const v=maxRuns*i/4;const y=P.t+ch-ch*i/4;return `<text x="${P.l-6}" y="${y+3}" text-anchor="end" fill="var(--dim)" font-size="9">${Math.round(v)}</text><line x1="${P.l}" y1="${y}" x2="${W-P.r}" y2="${y}" stroke="var(--border)" stroke-dasharray="2"/>`}).join('');
  const yR=Array.from({length:5},(_,i)=>{const v=maxCost*i/4;const y=P.t+ch-ch*i/4;return `<text x="${W-P.r+6}" y="${y+3}" text-anchor="start" fill="var(--accent)" font-size="9">$${v.toFixed(0)}</text>`}).join('');
  const nth=Math.ceil(data.length/7);
  const xLabels=data.map((d,i)=>i%nth===0?`<text x="${P.l+i*(barW+gap)+gap/2+barW/2}" y="${H-P.b+16}" text-anchor="middle" fill="var(--dim)" font-size="9">${esc(d.label)}</text>`:'').join('');
  $(id).innerHTML=`<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:350px">${yL}${yR}${xLabels}${bars}<path d="${line}" fill="none" stroke="var(--accent)" stroke-width="2"/>${dots}</svg><div class="chart-legend"><span class="chart-legend-item"><span class="chart-legend-dot" style="background:var(--purple)"></span>Runs</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background:var(--accent)"></span>Cost</span></div>`;
}

setInterval(()=>{timer--;if(timer<=0){loadData();timer=60}$('countdown').textContent=timer+'s'},1000);
loadData();
</script>
</body>
</html>
