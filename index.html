<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:rgba(255,255,255,0.03);--surfaceHover:rgba(255,255,255,0.045);--border:rgba(255,255,255,0.06);--accent:#6366f1;--accent2:#9333ea;--green:#4ade80;--yellow:#facc15;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;--text:#e5e5e5;--textStrong:#ffffff;--muted:#737373;--dim:#525252;--darker:#404040;--tableBg:rgba(255,255,255,0.025);--tableHover:rgba(255,255,255,0.05);--scrollThumb:rgba(255,255,255,0.1)}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:20px}
.container{max-width:1440px;margin:0 auto}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.header-left{display:flex;align-items:center;gap:12px}
.avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px}
.header-title{font-size:20px;font-weight:700;color:var(--textStrong)}
.header-status{display:flex;align-items:center;gap:6px;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot-on{background:var(--green);box-shadow:0 0 8px rgba(74,222,128,0.5)}
.dot-off{background:var(--red);box-shadow:0 0 8px rgba(248,113,113,0.5)}
.dot-warn{background:var(--yellow);box-shadow:0 0 8px rgba(250,204,21,0.5)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 2s ease-in-out infinite}
.header-right{display:flex;align-items:center;gap:12px}
.countdown{font-size:11px;color:var(--dim);font-variant-numeric:tabular-nums;min-width:24px}
.refresh-btn{background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:8px;color:var(--muted);font-size:12px;cursor:pointer;transition:all .15s}
.refresh-btn:hover{background:var(--surfaceHover);color:var(--textStrong)}

/* Theme switcher */
.theme-picker{position:relative;display:inline-block}
.theme-btn{background:var(--surface);border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:14px;cursor:pointer;transition:all .15s;line-height:1}
.theme-btn:hover{background:var(--surfaceHover);color:var(--textStrong)}
.theme-menu{display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:6px;min-width:200px;z-index:100;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.theme-menu.open{display:block}
.theme-menu-label{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding:6px 10px 4px}
.theme-opt{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text);transition:background .1s;border:none;background:none;width:100%;text-align:left}
.theme-opt:hover{background:var(--surfaceHover)}
.theme-opt.active{background:var(--surface);color:var(--textStrong);font-weight:600}
.theme-opt-icon{font-size:16px;width:22px;text-align:center}
.theme-opt-swatch{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);flex-shrink:0}
.last-update{font-size:11px;color:var(--dim)}

/* Glass card */
.glass{background:var(--surface);border:1px solid var(--border);border-radius:12px;transition:background .15s}
.glass:hover{background:var(--surfaceHover)}

/* Alerts */
.alerts-section{margin-bottom:16px}
.alert-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:6px}
.alert-critical{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2)}
.alert-high{background:rgba(251,146,60,.06);border:1px solid rgba(251,146,60,.15)}
.alert-medium{background:rgba(250,204,21,.06);border:1px solid rgba(250,204,21,.1)}
.alert-low{background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.1)}
.alert-icon{font-size:16px}
.alert-msg{font-size:12px;color:var(--text);flex:1}

/* System health row */
.health-row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:20px}
.health-item{padding:12px 14px;text-align:center}
.health-label{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.health-value{font-size:15px;font-weight:700;color:var(--textStrong)}

/* Cost cards */
.cost-row{display:grid;grid-template-columns:1fr 1fr 1fr 2fr;gap:16px;margin-bottom:24px}
.cost-card{padding:16px;position:relative;overflow:hidden}
.cost-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(99,102,241,.4),transparent)}
.cost-label{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.cost-value{font-size:28px;font-weight:700;color:var(--textStrong)}
.cost-sub{font-size:11px;color:var(--dim);margin-top:4px}
.donut-container{display:flex;align-items:center;gap:16px;height:100%}
.donut{width:100px;height:100px;border-radius:50%;position:relative;flex-shrink:0}
.donut-hole{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:55%;height:55%;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--textStrong)}
.donut-legend{display:flex;flex-direction:column;gap:3px;overflow:hidden}
.donut-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);white-space:nowrap}
.donut-legend-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

/* Kanban removed */

/* Section header */
.section-header{display:flex;align-items:center;justify-content:space-between;padding:0 4px;margin-bottom:10px;flex-wrap:wrap;gap:8px}
.section-title{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.section-count{font-size:11px;color:var(--dim)}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px}

/* Panel */
.panel{padding:16px}

/* Tables */
.dtable{width:100%;border-collapse:separate;border-spacing:0 3px}
.dtable th{padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);font-weight:600;text-align:left;white-space:nowrap}
.dtable th.r{text-align:right}
.dtable td{padding:9px 10px;font-size:12px;color:var(--muted)}
.dtable td.r{text-align:right}
.dtable td.w{color:var(--textStrong);font-weight:500}
.dtable td.cost{color:var(--textStrong);font-weight:600}
.dtable tr.dr{background:var(--tableBg);border-radius:8px}
.dtable tr.dr:hover{background:var(--tableHover)}
.dtable tr.dr td:first-child{border-radius:8px 0 0 8px}
.dtable tr.dr td:last-child{border-radius:0 8px 8px 0}
.dtable tr.total-row td{border-top:1px solid var(--border);color:var(--muted);font-weight:600}

/* Status dot inline */
.sd{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.sd-ok{background:var(--green)}
.sd-error{background:var(--red)}
.sd-none{background:var(--dim)}
.sd-pending{background:var(--yellow)}

/* Context bar */
.ctx-bar{width:80px;height:6px;background:var(--tableBg);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle}
.ctx-fill{height:100%;border-radius:3px}

/* Usage bar */
.usage-bar{height:6px;background:var(--tableBg);border-radius:3px;overflow:hidden}
.usage-fill{height:100%;border-radius:3px}

/* Badges */
.badge{font-size:9px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;padding:2px 8px;border-radius:4px;white-space:nowrap}
.badge-ok{background:rgba(74,222,128,.12);color:var(--green)}
.badge-err{background:rgba(248,113,113,.12);color:var(--red)}
.badge-active{background:rgba(74,222,128,.12);color:var(--green)}
.badge-available{background:rgba(99,102,241,.12);color:#818cf8}
.badge-none{background:var(--tableBg);color:var(--dim)}

/* Tab buttons */
.tab-group{display:flex;gap:4px}
.tab-btn{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--dim);transition:all .15s}
.tab-btn.active{background:rgba(99,102,241,.15);color:#818cf8;border-color:rgba(99,102,241,.3)}
.tab-btn.active-purple{background:rgba(168,85,247,.15);color:#c084fc;border-color:rgba(168,85,247,.3)}

/* Models grid */
.models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.model-card{padding:12px;text-align:center}
.model-name{font-size:13px;color:var(--textStrong);font-weight:600;margin-top:4px}
.model-id{font-size:10px;color:var(--dim);margin-top:3px;word-break:break-all}

/* Git log */
.git-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.git-item:last-child{border-bottom:none}
.git-hash{font-family:'SF Mono',Monaco,monospace;font-size:12px;color:var(--purple);font-weight:500;flex-shrink:0}
.git-msg{font-size:12px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}
.git-ago{font-size:10px;color:var(--dim);white-space:nowrap;flex-shrink:0}

/* Skills */
.skill-tag{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid;display:inline-block}

/* Tooltip */
[data-tip]{position:relative;cursor:help}
[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:var(--bg);color:var(--text);padding:6px 10px;border-radius:6px;font-size:11px;white-space:pre-wrap;max-width:300px;z-index:10;border:1px solid var(--border);pointer-events:none}

/* Type badge */
.type-badge{font-size:9px;padding:1px 6px;border-radius:3px;font-weight:500;text-transform:uppercase;letter-spacing:.05em}
.type-dm{background:rgba(99,102,241,.12);color:#818cf8}
.type-group{background:rgba(74,222,128,.12);color:var(--green)}
.type-cron{background:rgba(250,204,21,.12);color:var(--yellow)}
.type-subagent{background:rgba(168,85,247,.12);color:#c084fc}
.type-main{background:var(--tableBg);color:var(--muted)}
.type-telegram{background:rgba(99,102,241,.12);color:#818cf8}

.empty{text-align:center;padding:24px;color:var(--dim);font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--scrollThumb);border-radius:2px}

@media(max-width:1024px){.cost-row{grid-template-columns:repeat(2,1fr)}.health-row{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}.cost-row.health-row{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="container">

<!-- 1. Header Bar -->
<div class="header">
  <div class="header-left">
    <div class="avatar" id="botEmoji">‚ö°</div>
    <div>
      <div class="header-title" id="botName">OpenClaw Dashboard</div>
      <div class="header-status">
        <span class="dot dot-on pulse" id="statusDot"></span>
        <span style="color:var(--green);font-weight:500" id="statusText">Online</span>
      </div>
    </div>
  </div>
  <div class="header-right">
    <span class="countdown" id="countdown">60s</span>
    <span class="last-update" id="lastUpdate"></span>
    <div class="theme-picker">
      <button class="theme-btn" id="themeBtn" onclick="toggleThemeMenu()" title="Change theme">üé®</button>
      <div class="theme-menu" id="themeMenu"></div>
    </div>
    <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
  </div>
</div>

<!-- 2. Alerts Banner -->
<div class="alerts-section" id="alertsSection"></div>

<!-- 3. System Health Row -->
<div class="health-row" id="healthRow">
  <div class="glass health-item"><div class="health-label">Gateway</div><div class="health-value" id="hGw">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">PID</div><div class="health-value" id="hPid">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Uptime</div><div class="health-value" id="hUp">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Memory</div><div class="health-value" id="hMem">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Compaction</div><div class="health-value" id="hComp">‚Äî</div></div>
  <div class="glass health-item"><div class="health-label">Active Sessions</div><div class="health-value" id="hSess">‚Äî</div></div>
</div>

<!-- 4. Cost Row -->
<div class="cost-row">
  <div class="glass cost-card">
    <div class="cost-label">Today's Cost</div>
    <div class="cost-value" id="cToday">‚Äî</div>
    <div class="cost-sub" id="cTodaySub"></div>
  </div>
  <div class="glass cost-card">
    <div class="cost-label">All-Time Cost</div>
    <div class="cost-value" id="cAll">‚Äî</div>
    <div class="cost-sub" id="cAllSub"></div>
  </div>
  <div class="glass cost-card">
    <div class="cost-label">Projected Monthly</div>
    <div class="cost-value" id="cProj">‚Äî</div>
    <div class="cost-sub">Based on today's rate</div>
  </div>
  <div class="glass cost-card" style="padding:12px 16px">
    <div class="cost-label" style="margin-bottom:8px">Cost Breakdown</div>
    <div class="donut-container">
      <div class="donut" id="donut"><div class="donut-hole" id="donutCenter">$0</div></div>
      <div class="donut-legend" id="donutLegend"></div>
    </div>
  </div>
</div>


<!-- 6. Cron Jobs Panel -->
<div style="margin-bottom:24px">
  <div class="section-header"><span class="section-title">‚è∞ Cron Jobs</span><span class="section-count" id="cronCount"></span></div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable" id="cronTable">
      <thead><tr><th>Status</th><th>Name</th><th>Schedule</th><th>Last Run</th><th>Next Run</th><th class="r">Duration</th><th>Model</th></tr></thead>
      <tbody id="cronBody"></tbody>
    </table>
  </div>
</div>

<!-- 7. Active Sessions Panel -->
<div style="margin-bottom:24px">
  <div class="section-header"><span class="section-title">üì° Active Sessions</span><span class="section-count" id="sessCount"></span></div>
  <div class="glass panel" style="overflow-x:auto;max-height:400px;overflow-y:auto">
    <table class="dtable">
      <thead><tr><th>Name</th><th>Model</th><th>Type</th><th>Context %</th><th>Last Activity</th><th class="r">Tokens</th></tr></thead>
      <tbody id="sessBody"></tbody>
    </table>
  </div>
</div>

<!-- 8. Token Usage Table -->
<div style="margin-bottom:24px">
  <div class="section-header">
    <span class="section-title">üìä Token Usage & Cost</span>
    <div class="tab-group">
      <button class="tab-btn active" id="uTabT" onclick="uTab='today';render()">Today</button>
      <button class="tab-btn" id="uTabA" onclick="uTab='all';render()">All Time</button>
    </div>
  </div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable">
      <thead><tr><th>Model</th><th class="r">Calls</th><th class="r">Input</th><th class="r">Output</th><th class="r">Cache</th><th class="r">Total</th><th class="r">Cost</th><th style="min-width:100px">Usage</th></tr></thead>
      <tbody id="uBody"></tbody>
    </table>
  </div>
</div>

<!-- 9. Sub-Agent Usage Table -->
<div style="margin-bottom:24px">
  <div class="section-header">
    <span class="section-title" style="color:var(--purple)">ü§ñ Sub-Agent Activity</span>
    <div style="display:flex;align-items:center;gap:12px">
      <span id="subCostLbl" style="font-size:12px;color:var(--muted);font-weight:500"></span>
      <div class="tab-group">
        <button class="tab-btn active-purple" id="srTabT" onclick="srTab='today';render()">Today</button>
        <button class="tab-btn" id="srTabA" onclick="srTab='all';render()">All Time</button>
      </div>
    </div>
  </div>
  <div class="glass panel" style="overflow-x:auto">
    <table class="dtable">
      <thead><tr><th>Task</th><th>Model</th><th class="r">Cost</th><th class="r">Duration</th><th>Status</th><th>Time</th></tr></thead>
      <tbody id="srBody"></tbody>
    </table>
    <div class="empty" id="srEmpty" style="display:none">No sub-agent runs</div>
  </div>
  <!-- Sub-agent token breakdown -->
  <div style="margin-top:12px">
    <div class="section-header">
      <span class="section-title" style="color:var(--purple)">Sub-Agent Token Breakdown</span>
      <div class="tab-group">
        <button class="tab-btn active-purple" id="stTabT" onclick="stTab='today';render()">Today</button>
        <button class="tab-btn" id="stTabA" onclick="stTab='all';render()">All Time</button>
      </div>
    </div>
    <div class="glass panel" style="overflow-x:auto">
      <table class="dtable">
        <thead><tr><th>Model</th><th class="r">Calls</th><th class="r">Input</th><th class="r">Output</th><th class="r">Cache</th><th class="r">Total</th><th class="r">Cost</th><th style="min-width:100px">Usage</th></tr></thead>
        <tbody id="stBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 10. Bottom Row -->
<div class="grid-3">
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üß† Available Models</span></div>
    <div class="models-grid" id="modelsGrid"></div>
  </div>
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üîß Skills</span></div>
    <div style="display:flex;flex-wrap:wrap;gap:5px" id="skillsGrid"></div>
  </div>
  <div class="glass panel">
    <div class="section-header"><span class="section-title">üìú Git Log</span></div>
    <div id="gitPanel"></div>
  </div>
</div>

<div style="text-align:center;padding:12px;font-size:10px;color:var(--darker)">OpenClaw Dashboard ¬∑ Auto-refresh 60s</div>
</div>

<script>
// ‚îÄ‚îÄ Theme Engine ‚îÄ‚îÄ
let THEMES={},currentTheme='midnight';

async function loadThemes(){
  try{
    const r=await fetch('/themes.json?t='+Date.now());
    THEMES=await r.json();
  }catch(e){console.warn('themes.json not found, using defaults');return}
  const saved=localStorage.getItem('ocDashTheme');
  if(saved&&THEMES[saved])currentTheme=saved;
  applyTheme(currentTheme);
  renderThemeMenu();
}

function applyTheme(id){
  const t=THEMES[id];if(!t)return;
  currentTheme=id;
  const root=document.documentElement;
  const c=t.colors;
  root.style.setProperty('--bg',c.bg);
  root.style.setProperty('--surface',c.surface);
  root.style.setProperty('--surfaceHover',c.surfaceHover);
  root.style.setProperty('--border',c.border);
  root.style.setProperty('--accent',c.accent);
  root.style.setProperty('--accent2',c.accent2);
  root.style.setProperty('--green',c.green);
  root.style.setProperty('--yellow',c.yellow);
  root.style.setProperty('--red',c.red);
  root.style.setProperty('--orange',c.orange);
  root.style.setProperty('--purple',c.purple);
  root.style.setProperty('--text',c.text);
  root.style.setProperty('--textStrong',c.textStrong);
  root.style.setProperty('--muted',c.muted);
  root.style.setProperty('--dim',c.dim);
  root.style.setProperty('--darker',c.darker);
  root.style.setProperty('--tableBg',c.tableBg);
  root.style.setProperty('--tableHover',c.tableHover);
  root.style.setProperty('--scrollThumb',c.scrollThumb);
  localStorage.setItem('ocDashTheme',id);
  renderThemeMenu();
}

function renderThemeMenu(){
  const menu=$('themeMenu');if(!menu)return;
  const darkThemes=Object.entries(THEMES).filter(([,t])=>t.type==='dark');
  const lightThemes=Object.entries(THEMES).filter(([,t])=>t.type==='light');
  let html='<div class="theme-menu-label">Dark Themes</div>';
  darkThemes.forEach(([id,t])=>{
    html+=`<button class="theme-opt${id===currentTheme?' active':''}" onclick="applyTheme('${id}');event.stopPropagation()"><span class="theme-opt-icon">${t.icon}</span><span>${t.name}</span><span class="theme-opt-swatch" style="background:${t.colors.accent};margin-left:auto"></span></button>`;
  });
  html+='<div class="theme-menu-label" style="margin-top:4px">Light Themes</div>';
  lightThemes.forEach(([id,t])=>{
    html+=`<button class="theme-opt${id===currentTheme?' active':''}" onclick="applyTheme('${id}');event.stopPropagation()"><span class="theme-opt-icon">${t.icon}</span><span>${t.name}</span><span class="theme-opt-swatch" style="background:${t.colors.accent};margin-left:auto"></span></button>`;
  });
  menu.innerHTML=html;
}

function toggleThemeMenu(){
  const menu=$('themeMenu');
  menu.classList.toggle('open');
}
document.addEventListener('click',e=>{
  const picker=document.querySelector('.theme-picker');
  if(picker&&!picker.contains(e.target)){$('themeMenu').classList.remove('open')}
});

loadThemes();

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
let D={},uTab='today',srTab='today',stTab='today',timer=60;
const COLORS=['#6366f1','#9333ea','#ec4899','#f59e0b','#10b981','#06b6d4','#f87171','#84cc16'];
const $=id=>document.getElementById(id);
const esc=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';

function relTime(ts){
  if(!ts)return'‚Äî';
  let d;
  if(typeof ts==='number')d=new Date(ts);
  else{d=new Date(ts);if(isNaN(d))return ts}
  const diff=Math.floor((Date.now()-d)/1000);
  if(diff<60)return diff+'s ago';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

async function loadData(){
  try{
    const r=await fetch('/api/refresh?t='+Date.now());
    D=await r.json();render();
    $('lastUpdate').textContent='Updated: '+new Date().toLocaleTimeString();
    timer=60;
  }catch(e){
    $('alertsSection').innerHTML='<div class="alert-item alert-critical"><span class="alert-icon">‚ö†Ô∏è</span><span class="alert-msg">Failed to load data.json</span></div>';
  }
}

function render(){
  const gw=D.gateway||{};
  const on=gw.status==='online';

  // Header
  $('botName').textContent=D.botName||'OpenClaw Dashboard';
  $('botEmoji').textContent=D.botEmoji||'‚ö°';
  document.title=D.botName||'OpenClaw Dashboard';
  $('statusDot').className='dot '+(on?'dot-on pulse':'dot-off');
  $('statusText').textContent=on?'Online':'Offline';
  $('statusText').style.color=on?'var(--green)':'var(--red)';

  // Alerts
  const alerts=D.alerts||[];
  $('alertsSection').innerHTML=alerts.length?alerts.map(a=>`<div class="alert-item alert-${a.severity||'low'}"><span class="alert-icon">${a.icon||'‚ÑπÔ∏è'}</span><span class="alert-msg">${esc(a.message)}</span></div>`).join(''):'';

  // Health
  $('hGw').innerHTML=on?'<span style="color:var(--green)">‚óè</span> Online':'<span style="color:var(--red)">‚óè</span> Offline';
  $('hGw').style.color='var(--textStrong)';
  $('hPid').textContent=gw.pid||'‚Äî';
  $('hUp').textContent=gw.uptime||'‚Äî';
  $('hMem').textContent=gw.memory||'‚Äî';
  $('hComp').textContent=D.compactionMode||'‚Äî';
  $('hSess').textContent=D.sessionCount||0;

  // Cost
  $('cToday').textContent='$'+(D.totalCostToday||0).toFixed(2);
  $('cTodaySub').textContent='Sub-agents: $'+(D.subagentCostToday||0).toFixed(2);
  $('cAll').textContent='$'+(D.totalCostAllTime||0).toFixed(2);
  $('cAllSub').textContent='Sub-agents: $'+(D.subagentCostAllTime||0).toFixed(2);
  $('cProj').textContent='$'+(D.projectedMonthly||0).toFixed(0);

  // Donut (CSS conic-gradient)
  const bd=D.costBreakdown||[];
  const total=bd.reduce((a,d)=>a+d.cost,0)||1;
  let grad='',cum=0,legend='';
  bd.forEach((d,i)=>{
    const pct=d.cost/total*100;
    const c=COLORS[i%COLORS.length];
    grad+=`${c} ${cum}% ${cum+pct}%,`;
    cum+=pct;
    legend+=`<div class="donut-legend-item"><span class="donut-legend-dot" style="background:${c}"></span>${esc(d.model)} $${d.cost.toFixed(0)} (${Math.round(pct)}%)</div>`;
  });
  $('donut').style.background=`conic-gradient(${grad.slice(0,-1)})`;
  $('donutCenter').textContent='$'+total.toFixed(0);
  $('donutLegend').innerHTML=legend;

  // Kanban


  const crons=D.crons||[];
  $('cronCount').textContent=crons.length+' jobs';
  $('cronBody').innerHTML=crons.map(c=>{
    const st=c.lastStatus;
    const dotCls=st==='ok'?'sd-ok':st==='error'?'sd-error':st==='none'?'sd-none':'sd-pending';
    const tip=c.lastError?` data-tip="${esc(c.lastError)}"`:'';
    const dur=c.lastDurationMs?((c.lastDurationMs/1000).toFixed(1)+'s'):'‚Äî';
    return `<tr class="dr"><td><span class="sd ${dotCls}"${tip}></span>${st||'‚Äî'}</td><td class="w">${esc(c.name)}</td><td>${esc(c.schedule)}</td><td>${c.lastRun||'‚Äî'}</td><td>${c.nextRun||'‚Äî'}</td><td class="r">${dur}</td><td>${esc(c.model||'‚Äî')}</td></tr>`;
  }).join('');

  // Sessions
  const sess=(D.sessions||[]).slice(0,20);
  $('sessCount').textContent=(D.sessionCount||sess.length)+' total, '+sess.length+' shown';
  $('sessBody').innerHTML=sess.map(s=>{
    const pct=s.contextPct||0;
    const color=pct>80?'var(--red)':pct>50?'var(--yellow)':'var(--green)';
    const typeCls='type-'+(s.type||'main');
    return `<tr class="dr"><td class="w" style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.name)}</td><td>${esc(s.model)}</td><td><span class="type-badge ${typeCls}">${s.type||'‚Äî'}</span></td><td><div class="ctx-bar"><div class="ctx-fill" style="width:${pct}%;background:${color}"></div></div> <span style="font-size:11px;color:${color}">${pct}%</span></td><td>${relTime(s.updatedAt)}</td><td class="r">${(s.totalTokens||0).toLocaleString()}</td></tr>`;
  }).join('');

  // Token usage
  setTabCls('uTabT','uTabA',uTab,'active');
  renderTokenTbl('uBody',uTab==='today'?D.tokenUsageToday:D.tokenUsage,'var(--accent)');

  // Sub runs
  setTabCls('srTabT','srTabA',srTab,'active-purple');
  const runs=srTab==='today'?(D.subagentRunsToday||[]):(D.subagentRuns||[]);
  $('subCostLbl').textContent='Total: $'+(srTab==='today'?(D.subagentCostToday||0):(D.subagentCostAllTime||0)).toFixed(2);
  $('srEmpty').style.display=runs.length?'none':'block';
  $('srBody').innerHTML=runs.slice(0,20).map(r=>{
    const dur=r.durationSec>=3600?(r.durationSec/3600).toFixed(1)+'h':r.durationSec>=60?Math.round(r.durationSec/60)+'m':r.durationSec+'s';
    return `<tr class="dr"><td class="w" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.task)}</td><td>${esc(r.model)}</td><td class="r cost">$${r.cost.toFixed(4)}</td><td class="r">${dur}</td><td><span class="badge badge-ok">${r.status}</span></td><td>${r.timestamp}</td></tr>`;
  }).join('');

  // Sub token
  setTabCls('stTabT','stTabA',stTab,'active-purple');
  renderTokenTbl('stBody',stTab==='today'?D.subagentUsageToday:D.subagentUsage,'var(--purple)');

  // Models
  $('modelsGrid').innerHTML=(D.availableModels||[]).map(m=>`<div class="glass model-card"><span class="badge badge-${m.status}">${m.status}</span><div class="model-name">${esc(m.name)}</div><div class="model-id">${esc(m.provider)}</div></div>`).join('');

  // Skills
  $('skillsGrid').innerHTML=(D.skills||[]).map(s=>{
    const c=s.active?'color:var(--green);border-color:rgba(74,222,128,.2);background:rgba(74,222,128,.05)':'color:var(--dim);border-color:rgba(255,255,255,.04)';
    return `<span class="skill-tag" style="${c}">${esc(s.name)}</span>`;
  }).join('');

  // Git
  $('gitPanel').innerHTML=(D.gitLog||[]).slice(0,5).map(g=>`<div class="git-item"><span class="git-hash">${g.hash}</span><span class="git-msg" title="${esc(g.message)}">${esc(g.message)}</span><span class="git-ago">${g.ago}</span></div>`).join('')||'<div class="empty">No git history</div>';
}

function renderTokenTbl(bodyId,data,accentColor){
  data=data||[];
  const max=Math.max(...data.map(u=>u.cost))||1;
  $(bodyId).innerHTML=data.map(u=>{
    const pct=Math.round(u.cost/max*100);
    return `<tr class="dr"><td class="w">${esc(u.model)}</td><td class="r">${u.calls.toLocaleString()}</td><td class="r">${u.input}</td><td class="r">${u.output}</td><td class="r">${u.cacheRead}</td><td class="r" style="color:var(--textStrong);font-weight:500">${u.totalTokens}</td><td class="r cost">$${u.cost.toFixed(2)}</td><td><div class="usage-bar"><div class="usage-fill" style="width:${pct}%;background:${accentColor}"></div></div></td></tr>`;
  }).join('')+(data.length?`<tr class="total-row"><td class="w">TOTAL</td><td class="r">${data.reduce((a,u)=>a+u.calls,0).toLocaleString()}</td><td colspan="4"></td><td class="r cost">$${data.reduce((a,u)=>a+u.cost,0).toFixed(2)}</td><td></td></tr>`:'');
}

function setTabCls(tId,aId,tab,cls){
  $(tId).className='tab-btn'+(tab==='today'?' '+cls:'');
  $(aId).className='tab-btn'+(tab==='all'?' '+cls:'');
}

setInterval(()=>{timer--;if(timer<=0){loadData();timer=60}$('countdown').textContent=timer+'s'},1000);
loadData();
</script>
</body>
</html>
